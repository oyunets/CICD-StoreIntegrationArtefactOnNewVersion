def artifactIds = []

pipeline {
    agent any

    //Configure the following environment variables before executing the Jenkins Job
    environment {
        IntegrationPackageID = "EPAM"
        CPIHost = 'f4c7d2e5trial.it-cpitrial06.cfapps.us10-001.hana.ondemand.com'
        CPIOAuthHost = 'f4c7d2e5trial.authentication.us10.hana.ondemand.com/oauth/token'
        CPIOAuthCredentials = 'ci-api'
        GITRepositoryURL = 'github.com/oyunets/books'
        GITCredentials = 'git'
        GITBranch = 'main'
        GITComment = "Integration Artefacts update from CI/CD pipeline"
        GITFolder = "IntegrationContent/${IntegrationPackageID}/IntegrationArtefacts"
    }

//    parameters {
//        string(name: 'IntegrationPackageID', defaultValue: 'IntegrationPackageID', description: 'Integration Package ID')
//    }

    stages {
        stage('Initialization') {
            steps {
                script {
                    //clean up workspace first
                    echo 'Initialize pipeline'
                    deleteDir()
                }
            }
        }

        stage('Get List of Integration Designtime Artifacts') {
            steps {
                script {
                    //get Cloud Integration Oauth token
                    def cpiTokenResponse = httpRequest acceptType: 'APPLICATION_JSON',
                            authentication: env.CPIOAuthCredentials,
                            ignoreSslErrors: false,
                            responseHandle: 'LEAVE_OPEN',
                            timeout: 30,
                            url: 'https://' + env.CPIOAuthHost + '/oauth/token?grant_type=client_credentials'
                    def jsonObj = readJSON text: cpiTokenResponse.content
                    def cpiToken = 'bearer' + ' ' + jsonObj.access_token
                    cpiTokenResponse.close()

                    //download and extract list of integration flowsfrom Cloud Integration tenant
                    println("Download artefact")
                    def cpiPackageResponse = httpRequest acceptType: 'APPLICATION_JSON',
                            customHeaders: [[maskValue: true, name: 'Authorization', value: cpiToken]],
                            ignoreSslErrors: false,
                            responseHandle: 'LEAVE_OPEN',
                            timeout: 30,
                            url: 'https://' + env.CPIHost + '/api/v1/IntegrationPackages(Id=\'' + env.IntegrationPackageID + '\')/IntegrationDesigntimeArtifacts'
                    def jsonObj2 = readJSON text: cpiPackageResponse.content
                    jsonObj2.d.results.each { result ->
                        artifactIds.push(result.Id)
                        println(result)
                    }
                    cpiPackageResponse.close()
                }
            }
        }

        stage('Process iFlows ') {
            steps {
                script {
                    artifactIds.each { id ->
                        echo 'Start job with IntegrationFlowID = ' + id
                        build job: 'iFlow', wait: false, parameters: [
                                string(name: 'IntegrationPackageID', value: IntegrationPackageID),
                                string(name: 'IntegrationFlowID', value: id),
                                string(name: 'CPIHost', value: CPIHost),
                                string(name: 'CPIOAuthHost', value: CPIOAuthHost),
                                string(name: 'CPIOAuthCredentials', value: CPIOAuthCredentials),
                                string(name: 'GITRepositoryURL', value: GITRepositoryURL),
                                string(name: 'GITCredentials', value: GITCredentials),
                                string(name: 'GITBranch', value: GITBranch),
                                string(name: 'GITComment', value: GITComment),
                                string(name: 'GITFolder', value: GITFolder)
                        ]
                    }
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    //clean up workspace
                    echo 'Clean pipeline'
                    deleteDir()
                }
            }
        }
    }
}